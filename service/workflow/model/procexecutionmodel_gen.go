// Code generated by goctl. DO NOT EDIT.
// versions:
//  goctl version: 1.7.2

package model

import (
	"context"
	"database/sql"
	"fmt"
	"github.com/Masterminds/squirrel"
	"strings"
	"time"

	"github.com/zeromicro/go-zero/core/stores/builder"
	"github.com/zeromicro/go-zero/core/stores/cache"
	"github.com/zeromicro/go-zero/core/stores/sqlc"
	"github.com/zeromicro/go-zero/core/stores/sqlx"
	"github.com/zeromicro/go-zero/core/stringx"
)

var (
	procExecutionFieldNames          = builder.RawFieldNames(&ProcExecution{})
	procExecutionRows                = strings.Join(procExecutionFieldNames, ",")
	procExecutionRowsExpectAutoSet   = strings.Join(stringx.Remove(procExecutionFieldNames, "`id`", "`create_at`", "`create_time`", "`update_at`", "`update_time`"), ",")
	procExecutionRowsWithPlaceHolder = strings.Join(stringx.Remove(procExecutionFieldNames, "`id`", "`create_at`", "`create_time`", "`update_at`", "`update_time`"), "=?,") + "=?"

	cacheProcExecutionIdPrefix = "cache:procExecution:id:"
	cacheProcExecutionProcIdPrefix = "cache:procExecution:proc_id:"
)

type (
	procExecutionModel interface {
		Insert(ctx context.Context, data *ProcExecution) (sql.Result, error)
		TransInsert(ctx context.Context, session sqlx.Session,data *ProcExecution) (sql.Result, error)
		FindOne(ctx context.Context, id int64) (*ProcExecution, error)
		FindOneByProcId(ctx context.Context, procId int64) (*ProcExecution, error)
		FindOneByProcIdAndNodeType(ctx context.Context, procId,nodeType int64) (*ProcExecution, error)
		Update(ctx context.Context, data *ProcExecution) error
		TransUpdate(ctx context.Context, session sqlx.Session,data *ProcExecution) error
		Delete(ctx context.Context, id int64) error
		FindCount(ctx context.Context, countBuilder squirrel.SelectBuilder) (int64, error)
		FindList(ctx context.Context, rowBuilder squirrel.SelectBuilder, current, pageSize int64) ([]*ProcExecution, error)
		RowBuilder() squirrel.SelectBuilder
		CountBuilder(field string) squirrel.SelectBuilder
		SumBuilder(field string) squirrel.SelectBuilder
		TransCtx(ctx context.Context, fn func(ctx context.Context, sqlx sqlx.Session) error) error
	}

	defaultProcExecutionModel struct {
		sqlc.CachedConn
		table string
	}

	ProcExecution struct {
		Id          int64          `db:"id"`           // 执行ID
		ProcId      int64          `db:"proc_id"`      // 实例ID
		ProcVersion int64          `db:"proc_version"` // 流程版本号
		ProcName    string         `db:"proc_name"`    // 流程名
		NodeId      string         `db:"node_id"`      // 节点ID
		NodeName    string         `db:"node_name"`    // 节点名称
		PrevNodeId  string         `db:"prev_node_id"` // 上级节点ID
		NodeType    int64          `db:"node_type"`    // 节点类型 0 开始节点，1 任务节点 ，2 网关节点，3 结束节点
		IsCosigned  int64          `db:"is_cosigned"`  // 是否会签  0 不会签  1 会签
		TenantId    string         `db:"tenant_id"`    // 租户ID
		Data        sql.NullString `db:"data"`
		CreatedAt   time.Time      `db:"created_at"`   // 创建时间
		UpdatedAt   sql.NullTime   `db:"updated_at"`   // 更新时间
		DeletedAt   sql.NullTime   `db:"deleted_at"`   // 删除时间
		CreatedName string         `db:"created_name"` // 创建人
		UpdatedName sql.NullString `db:"updated_name"` // 更新人
		DeletedName sql.NullString `db:"deleted_name"` // 删除人
	}
)

func newProcExecutionModel(conn sqlx.SqlConn, c cache.CacheConf, opts ...cache.Option) *defaultProcExecutionModel {
	return &defaultProcExecutionModel{
		CachedConn: sqlc.NewConn(conn, c, opts...),
		table:      "`proc_execution`",
	}
}

func (m *defaultProcExecutionModel) Delete(ctx context.Context, id int64) error {
	procExecutionIdKey := fmt.Sprintf("%s%v", cacheProcExecutionIdPrefix, id)
	_, err := m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("delete from %s where `id` = ?", m.table)
		return conn.ExecCtx(ctx, query, id)
	}, procExecutionIdKey)
	return err
}

func (m *defaultProcExecutionModel) FindOne(ctx context.Context, id int64) (*ProcExecution, error) {
	procExecutionIdKey := fmt.Sprintf("%s%v", cacheProcExecutionIdPrefix, id)
	var resp ProcExecution
	err := m.QueryRowCtx(ctx, &resp, procExecutionIdKey, func(ctx context.Context, conn sqlx.SqlConn, v any) error {
		query := fmt.Sprintf("select %s from %s where `id` = ? limit 1", procExecutionRows, m.table)
		return conn.QueryRowCtx(ctx, v, query, id)
	})
	switch err {
	case nil:
		return &resp, nil
	case sqlc.ErrNotFound:
		return nil, sqlx.ErrNotFound
	default:
		return nil, err
	}

}

func (m *defaultProcExecutionModel) FindOneByProcId(ctx context.Context, procId int64) (*ProcExecution, error) {
	procExecutionProcIdKey := fmt.Sprintf("%s%v", cacheProcExecutionProcIdPrefix, procId)
	var resp ProcExecution
	err := m.QueryRowCtx(ctx, &resp, procExecutionProcIdKey, func(ctx context.Context, conn sqlx.SqlConn, v any) error {
		query := fmt.Sprintf("select %s from %s where `proc_id` = ? limit 1", procExecutionRows, m.table)
		return conn.QueryRowCtx(ctx, v, query, procId)
	})
	switch err {
	case nil:
		return &resp, nil
	case sqlc.ErrNotFound:
		return nil, sqlx.ErrNotFound
	default:
		return nil, err
	}

}

func (m *defaultProcExecutionModel) FindOneByProcIdAndNodeType(ctx context.Context, procId,nodeType int64) (*ProcExecution, error){
	procExecutionProcIdKey := fmt.Sprintf("%s%v", cacheProcExecutionProcIdPrefix, procId)
	var resp ProcExecution
	err := m.QueryRowCtx(ctx, &resp, procExecutionProcIdKey, func(ctx context.Context, conn sqlx.SqlConn, v any) error {
		query := fmt.Sprintf("select %s from %s where `proc_id` = ?  and  `node_type` = ?  limit 1", procExecutionRows, m.table)
		return conn.QueryRowCtx(ctx, v, query, procId,nodeType)
	})
	switch err {
	case nil:
		return &resp, nil
	case sqlc.ErrNotFound:
		return nil, sqlx.ErrNotFound
	default:
		return nil, err
	}

}

func (m *defaultProcExecutionModel) Insert(ctx context.Context, data *ProcExecution) (sql.Result, error) {
	procExecutionIdKey := fmt.Sprintf("%s%v", cacheProcExecutionIdPrefix, data.Id)
	ret, err := m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("insert into %s (%s) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)", m.table, procExecutionRowsExpectAutoSet)
		return conn.ExecCtx(ctx, query, data.ProcId, data.ProcVersion, data.ProcName, data.NodeId, data.NodeName, data.PrevNodeId, data.NodeType, data.IsCosigned, data.TenantId, data.Data, data.CreatedAt, data.UpdatedAt, data.DeletedAt, data.CreatedName, data.UpdatedName, data.DeletedName)
	}, procExecutionIdKey)
	return ret, err
}

func (m *defaultProcExecutionModel) TransInsert(ctx context.Context, session sqlx.Session,data *ProcExecution) (sql.Result, error) {
	procExecutionIdKey := fmt.Sprintf("%s%v", cacheProcExecutionIdPrefix, data.Id)
	ret, err := m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("insert into %s (%s) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)", m.table, procExecutionRowsExpectAutoSet)
		return session.ExecCtx(ctx, query, data.ProcId, data.ProcVersion, data.ProcName, data.NodeId, data.NodeName, data.PrevNodeId, data.NodeType, data.IsCosigned, data.TenantId, data.Data, data.CreatedAt, data.UpdatedAt, data.DeletedAt, data.CreatedName, data.UpdatedName, data.DeletedName)
	}, procExecutionIdKey)
	return ret, err
}

func (m *defaultProcExecutionModel) Update(ctx context.Context, data *ProcExecution) error {
	procExecutionIdKey := fmt.Sprintf("%s%v", cacheProcExecutionIdPrefix, data.Id)
	_, err := m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("update %s set %s where `id` = ?", m.table, procExecutionRowsWithPlaceHolder)
		return conn.ExecCtx(ctx, query, data.ProcId, data.ProcVersion, data.ProcName, data.NodeId, data.NodeName, data.PrevNodeId, data.NodeType, data.IsCosigned, data.TenantId, data.Data, data.CreatedAt, data.UpdatedAt, data.DeletedAt, data.CreatedName, data.UpdatedName, data.DeletedName, data.Id)
	}, procExecutionIdKey)
	return err
}

func (m *defaultProcExecutionModel) TransUpdate(ctx context.Context, session sqlx.Session,data *ProcExecution) error {
	procExecutionIdKey := fmt.Sprintf("%s%v", cacheProcExecutionIdPrefix, data.Id)
	_, err := m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("update %s set %s where `id` = ?", m.table, procExecutionRowsWithPlaceHolder)
		return session.ExecCtx(ctx, query, data.ProcId, data.ProcVersion, data.ProcName, data.NodeId, data.NodeName, data.PrevNodeId, data.NodeType, data.IsCosigned, data.TenantId, data.Data, data.CreatedAt, data.UpdatedAt, data.DeletedAt, data.CreatedName, data.UpdatedName, data.DeletedName, data.Id)
	}, procExecutionIdKey)
	return err
}
func (m *defaultProcExecutionModel) RowBuilder() squirrel.SelectBuilder {
	return squirrel.Select(procExecutionRows).From(m.table)
}

func (m *defaultProcExecutionModel) CountBuilder(field string) squirrel.SelectBuilder {
	return squirrel.Select("COUNT(" + field + ")").From(m.table)
}

func (m *defaultProcExecutionModel) SumBuilder(field string) squirrel.SelectBuilder {
	return squirrel.Select("IFNULL(SUM(" + field + "),0)").From(m.table)
}

func (m *defaultProcExecutionModel) FindCount(ctx context.Context, countBuilder squirrel.SelectBuilder) (int64, error) {

	query, values, err := countBuilder.ToSql()
	if err != nil {
		return 0, err
	}

	var resp int64
	err = m.QueryRowNoCacheCtx(ctx, &resp, query, values...)
	switch err {
	case nil:
		return resp, nil
	case sqlc.ErrNotFound:
		return 0, nil
	default:
		return 0, err
	}
}

func (m *defaultProcExecutionModel) FindList(ctx context.Context, rowBuilder squirrel.SelectBuilder, current, pageSize int64) ([]*ProcExecution, error) {

	if current < 1 {
		current = 1
	}
	offset := (current - 1) * pageSize

	query, values, err := rowBuilder.Offset(uint64(offset)).Limit(uint64(pageSize)).ToSql()
	if err != nil {
		return nil, err
	}

	var resp []*ProcExecution
	err = m.QueryRowsNoCacheCtx(ctx, &resp, query, values...)
	switch err {
	case nil:
		return resp, nil
	case sqlc.ErrNotFound:
		return nil, nil
	default:
		return nil, err
	}
}

func (m *defaultProcExecutionModel) TransCtx(ctx context.Context, fn func(ctx context.Context, sqlx sqlx.Session) error) error {
	return m.Transact(func(s sqlx.Session) error {
		return fn(ctx, s)
	})
}

func (m *defaultProcExecutionModel) formatPrimary(primary any) string {
	return fmt.Sprintf("%s%v", cacheProcExecutionIdPrefix, primary)
}

func (m *defaultProcExecutionModel) queryPrimary(ctx context.Context, conn sqlx.SqlConn, v, primary any) error {
	query := fmt.Sprintf("select %s from %s where `id` = ? limit 1", procExecutionRows, m.table)
	return conn.QueryRowCtx(ctx, v, query, primary)
}

func (m *defaultProcExecutionModel) tableName() string {
	return m.table
}
